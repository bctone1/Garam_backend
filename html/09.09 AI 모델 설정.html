<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 모델 설정 - 가람포스텍 AI 관리센터</title>

    <!-- 폰트 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-color: #1e60e1;
            --primary-dark: #1a54c7;
            --primary-light: rgba(30, 96, 225, 0.1);
            --accent-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --secondary-color: #f8f9fa;
            --bg-white: #ffffff;
            --text-primary: #2c3e50;
            --text-secondary: #6c757d;
            --border-color: #e9ecef;
            --border-radius: 6px;
            --border-radius-lg: 12px;
            --shadow-sm: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            --shadow-md: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            --transition: all 0.2s ease-in-out;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: #f8fafc;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        .admin-wrapper {
            display: flex;
            min-height: 100vh;
        }

        /* 왼쪽 사이드바 */
        .sidebar {
            width: 280px;
            background: #1e293b;
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid #334155;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .brand-logo {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            border-radius: var(--border-radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .brand-info {
            flex: 1;
        }

        .brand-name {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: white;
        }

        .brand-subtitle {
            font-size: 0.875rem;
            color: #94a3b8;
        }

        .sidebar-nav {
            padding: 1.5rem 0;
            flex: 1;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 0.25rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.5rem;
            color: #cbd5e1;
            text-decoration: none;
            transition: var(--transition);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .nav-link:hover {
            background: #334155;
            color: white;
        }

        .nav-link.active {
            background: var(--primary-color);
            color: white;
            border-right: 3px solid var(--primary-light);
        }

        .sidebar-footer {
            margin-top: auto;
            padding: 1.5rem;
            border-top: 1px solid #334155;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            color: white;
            font-size: 0.875rem;
        }

        .user-email {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .sidebar-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: #334155;
            color: #cbd5e1;
            border-radius: var(--border-radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .action-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        /* 메인 콘텐츠 */
        .main-content {
            flex: 1;
            margin-left: 280px;
            background: #f8fafc;
        }

        .top-header {
            background: var(--bg-white);
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .mobile-menu-btn {
            display: none;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: var(--primary-light);
            color: var(--primary-color);
            cursor: pointer;
            transition: var(--transition);
        }

        .mobile-menu-btn:hover,
        .mobile-menu-btn:focus-visible {
            background: var(--primary-color);
            color: white;
            outline: none;
        }

        .page-title h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .page-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--primary-light);
            border-radius: 20px;
            color: var(--primary-color);
            font-weight: 500;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-color);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--bg-white);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .main-container {
            padding: 2rem;
        }

        /* 현재 상태 */
        .status-card {
            background: var(--bg-white);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--accent-color);
        }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .status-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--primary-light);
            border-radius: 20px;
            color: var(--primary-color);
            font-weight: 500;
        }

        .simple-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .metric-item {
            text-align: center;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
        }

        .metric-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* 섹션 */
        .section {
            background: var(--bg-white);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-sm);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* 모델 카드 */
        .model-card {
            background: var(--primary-light);
            border: 2px solid var(--primary-color);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            position: relative;
        }

        .model-card::before {
            content: '현재 사용중';
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--accent-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .model-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .model-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            background: var(--accent-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .model-info {
            flex: 1;
        }

        .model-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .model-provider {
            font-size: 1rem;
            color: var(--text-secondary);
        }

        .model-description {
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        .model-features {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .feature-tag {
            padding: 0.5rem 1rem;
            background: var(--bg-white);
            color: var(--primary-color);
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            border: 1px solid var(--primary-color);
        }

        /* 설정 그룹 */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .setting-card {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
        }

        .setting-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .setting-group {
            margin-bottom: 1.5rem;
        }

        .setting-label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 0.875rem;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(30, 96, 225, 0.1);
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 0.75rem;
        }

        .toggle-info h4 {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .toggle-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .toggle {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--border-color);
            border-radius: 13px;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            padding: 0;
        }

        .toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: var(--transition);
        }

        .toggle[aria-pressed="true"] {
            background: var(--primary-color);
        }

        .toggle[aria-pressed="true"]::after {
            transform: translateX(24px);
        }

        .toggle:focus-visible {
            outline: 3px solid var(--primary-light);
            outline-offset: 2px;
        }

        /* 액션 버튼 */
        .actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
        }

        /* 반응형 */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .top-header {
                padding: 1rem 1.5rem;
            }

            .mobile-menu-btn {
                display: inline-flex;
            }
        }

        @media (max-width: 768px) {
            .top-header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .main-container {
                padding: 1rem;
            }

            .simple-metrics {
                grid-template-columns: repeat(2, 1fr);
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }

            .actions {
                flex-direction: column;
                align-items: center;
            }
        }

        /* 애니메이션 */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>

<body>
    <div class="admin-wrapper">
        <!-- 왼쪽 사이드바 -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="brand-logo">
                    <i class="fas fa-microchip"></i>
                </div>
                <div class="brand-info">
                    <h2 class="brand-name">가람포스텍</h2>
                    <p class="brand-subtitle">AI 관리센터</p>
                </div>
            </div>

            <nav class="sidebar-nav">
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="09.09 대시보드.html" class="nav-link">
                            <i class="fas fa-tachometer-alt"></i>
                            <span class="nav-text">대시보드</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="09.09 지식베이스 관리.html" class="nav-link">
                            <i class="fas fa-book"></i>
                            <span class="nav-text">지식베이스 관리</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="09.09 AI 모델 설정.html" class="nav-link active">
                            <i class="fas fa-robot"></i>
                            <span class="nav-text">AI 모델 설정</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="09.09 분석 및 보고서.html" class="nav-link">
                            <i class="fas fa-chart-bar"></i>
                            <span class="nav-text">분석 및 보고서</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="09.09 챗봇 운영 설정.html" class="nav-link">
                            <i class="fas fa-comments"></i>
                            <span class="nav-text">챗봇 운영 설정</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="09.15 문의 관리.html" class="nav-link">
                            <i class="fas fa-comments"></i>
                            <span class="nav-text">문의 관리</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <div class="user-info">
                        <div class="user-name">관리자</div>
                        <div class="user-email">admin@garampos.com</div>
                    </div>
                </div>
                <div class="sidebar-actions">
                    <button class="action-btn" title="로그아웃">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- 메인 콘텐츠 -->
        <main class="main-content">
            <!-- 상단 헤더 -->
            <header class="top-header">
                <div class="header-left">
                    <button type="button" class="mobile-menu-btn" aria-controls="sidebar" aria-expanded="false">
                        <span class="sr-only">사이드바 열기/닫기</span>
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="page-title">
                        <h1>AI 모델 설정</h1>
                        <p class="page-subtitle" id="pageSubtitle">EXAONE 4.0 모델의 성능과 동작을 조정하여 최적의 응답을 생성하세요</p>
                    </div>
                </div>
                <div class="header-right">
                    <div class="status-indicator">
                        <div class="status-dot"></div>
                        <span id="statusIndicatorText">EXAONE 4.0 활성</span>
                    </div>
                </div>
            </header>

            <div class="main-container">
                <!-- 현재 상태 -->
                <div class="status-card">
                    <div class="status-header">
                        <h2 class="status-title">모델 운영 현황</h2>
                        <div class="status-badge">
                            <div class="status-dot"></div>
                            <span id="statusBadgeText">정상 운영중</span>
                        </div>
                    </div>
                    <div class="simple-metrics">
                        <div class="metric-item">
                            <div class="metric-value" id="accuracyValue">94%</div>
                            <div class="metric-label">응답 정확도</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value" id="responseTimeValue">1.2초</div>
                            <div class="metric-label">평균 응답시간</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value" id="monthlyConversationValue">847</div>
                            <div class="metric-label">이번 달 처리 문의</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value" id="uptimeValue">99.8%</div>
                            <div class="metric-label">모델 가동률</div>
                        </div>
                    </div>
                </div>

                <!-- AI 모델 정보 -->
                <div class="section">
                    <h2 class="section-title">
                        <i class="fas fa-brain"></i>
                        현재 AI 모델
                    </h2>
                    <div class="model-card">
                        <div class="model-header">
                            <div class="model-icon">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="model-info">
                                <div class="model-name" id="modelName">EXAONE 4.0</div>
                                <div class="model-provider" id="modelProvider">LG AI Research</div>
                            </div>
                        </div>

                        <div class="model-description" id="modelDescription">
                            한국 최초 하이브리드 AI 모델로 자연어 처리와 추론 능력을 통합하여 제공합니다.
                            한국어에 특화되어 기술지원에 최적화되었으며, 높은 정확도와 빠른 응답 속도를 자랑합니다.
                        </div>

                        <div class="model-features" id="modelFeatures">
                            <span class="feature-tag">한국어 특화</span>
                            <span class="feature-tag">하이브리드 추론</span>
                            <span class="feature-tag">기술지원 최적화</span>
                            <span class="feature-tag">131K 토큰 컨텍스트</span>
                        </div>
                    </div>
                </div>

                <!-- 응답 스타일 설정 -->
                <div class="section">
                    <h2 class="section-title">
                        <i class="fas fa-comments"></i>
                        응답 스타일 설정
                    </h2>
                    <div class="settings-grid">
                        <div class="setting-card">
                            <div class="setting-title">
                                <i class="fas fa-user-tie"></i>
                                응답 톤앤매너
                            </div>
                            <div class="setting-group">
                                <label class="setting-label">응답 스타일</label>
                                <select class="input-field" id="responseStyle">
                                    <option value="professional" selected>전문적이고 정확한 답변</option>
                                    <option value="friendly">친근하고 대화형 답변</option>
                                    <option value="concise">간결하고 핵심적인 답변</option>
                                </select>
                                <small style="color: var(--text-secondary);">
                                    챗봇의 답변 톤앤매너를 설정합니다
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 응답 품질 설정 -->
                <div class="section">
                    <h2 class="section-title">
                        <i class="fas fa-cog"></i>
                        응답 품질 설정
                    </h2>
                    <div class="settings-grid" style="grid-template-columns: repeat(2, 1fr);">
                        <div class="setting-card">
                            <div class="setting-title">
                                <i class="fas fa-shield-alt"></i>
                                안전성 및 필터링
                            </div>
                            <div class="toggle-switch">
                                <div class="toggle-info">
                                    <h4>부적절한 질문 차단</h4>
                                    <div class="toggle-description">욕설, 스팸 자동 차단</div>
                                </div>
                                <button type="button" class="toggle" data-setting="block_inappropriate" aria-pressed="true">
                                    <span class="sr-only">부적절한 질문 차단 설정</span>
                                </button>
                            </div>
                            <div class="toggle-switch">
                                <div class="toggle-info">
                                    <h4>기술 외 문의 제한</h4>
                                    <div class="toggle-description">기술지원 외 주제 응답 제한</div>
                                </div>
                                <button type="button" class="toggle" data-setting="restrict_non_tech" aria-pressed="true">
                                    <span class="sr-only">기술 외 문의 제한 설정</span>
                                </button>
                            </div>
                        </div>

                        <div class="setting-card">
                            <div class="setting-title">
                                <i class="fas fa-clock"></i>
                                응답 최적화
                            </div>
                                <div class="toggle-switch">
                                    <div class="toggle-info">
                                        <h4>빠른 응답 모드</h4>
                                        <div class="toggle-description">간단한 질문에 즉시 답변</div>
                                    </div>
                                    <button type="button" class="toggle" data-setting="fast_response_mode" aria-pressed="true">
                                        <span class="sr-only">빠른 응답 모드 설정</span>
                                    </button>
                                </div>
                                <div class="toggle-switch">
                                    <div class="toggle-info">
                                        <h4>상담원 연결 추천</h4>
                                        <div class="toggle-description">복잡한 문의시 상담원 연결 안내</div>
                                    </div>
                                    <button type="button" class="toggle" data-setting="suggest_agent_handoff" aria-pressed="true">
                                        <span class="sr-only">상담원 연결 추천 설정</span>
                                    </button>
                                </div>
                            </div>
                    </div>
                </div>

                <!-- 액션 버튼 -->
                <div class="actions">
                    <button class="btn btn-secondary" id="resetBtn" type="button">
                        <i class="fas fa-undo"></i>
                        기본값 복원
                    </button>
                    <button class="btn btn-primary" id="saveBtn">
                        <i class="fas fa-save"></i>
                        설정 저장
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE_URL = localStorage.getItem('garam_api_base_url') || 'http://localhost:5000';

        function buildApiUrl(path = '') {
            const base = API_BASE_URL.endsWith('/') ? API_BASE_URL.slice(0, -1) : API_BASE_URL;
            if (!path) {
                return base;
            }
            return `${base}${path.startsWith('/') ? path : `/${path}`}`;
        }

        async function fetchJSON(url, options = {}) {
            const opts = { ...options };
            opts.headers = { ...(options.headers || {}) };

            if (opts.body && !(opts.body instanceof FormData) && typeof opts.body !== 'string') {
                if (!opts.headers['Content-Type']) {
                    opts.headers['Content-Type'] = 'application/json';
                }
                opts.body = JSON.stringify(opts.body);
            }

            try {
                const response = await fetch(url, opts);
                const text = await response.text();

                if (!response.ok) {
                    let message = `HTTP ${response.status}`;
                    if (text) {
                        try {
                            const parsed = JSON.parse(text);
                            message = parsed?.detail || parsed?.message || message;
                        } catch (parseError) {
                            message = text;
                        }
                    }
                    const error = new Error(message);
                    error.status = response.status;
                    throw error;
                }

                if (!text) {
                    return null;
                }

                try {
                    return JSON.parse(text);
                } catch (parseError) {
                    return null;
                }
            } catch (error) {
                if (error instanceof Error) {
                    throw error;
                }
                const fallback = new Error('네트워크 오류가 발생했습니다.');
                fallback.status = 0;
                throw fallback;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.getElementById('sidebar');
            const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
            const mainContent = document.querySelector('.main-content');

            const closeSidebar = () => {
                if (sidebar && sidebar.classList.contains('open')) {
                    sidebar.classList.remove('open');
                    if (mobileMenuBtn) {
                        mobileMenuBtn.setAttribute('aria-expanded', 'false');
                    }
                }
            };

            if (mobileMenuBtn && sidebar) {
                mobileMenuBtn.addEventListener('click', () => {
                    const isOpen = sidebar.classList.toggle('open');
                    mobileMenuBtn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
                });
            }

            if (mainContent) {
                mainContent.addEventListener('click', () => {
                    if (window.innerWidth <= 1024) {
                        closeSidebar();
                    }
                });
            }

            if (sidebar) {
                sidebar.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', () => {
                        if (window.innerWidth <= 1024) {
                            closeSidebar();
                        }
                    });
                });
            }

            window.addEventListener('resize', () => {
                if (window.innerWidth > 1024) {
                    closeSidebar();
                }
            });

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    closeSidebar();
                }
            });

            const elements = {
                statusIndicatorText: document.getElementById('statusIndicatorText'),
                statusBadgeText: document.getElementById('statusBadgeText'),
                accuracyValue: document.getElementById('accuracyValue'),
                responseTimeValue: document.getElementById('responseTimeValue'),
                monthlyConversationValue: document.getElementById('monthlyConversationValue'),
                uptimeValue: document.getElementById('uptimeValue'),
                modelName: document.getElementById('modelName'),
                modelProvider: document.getElementById('modelProvider'),
                modelDescription: document.getElementById('modelDescription'),
                modelFeatures: document.getElementById('modelFeatures'),
                responseStyle: document.getElementById('responseStyle'),
                pageSubtitle: document.getElementById('pageSubtitle'),
                saveButton: document.getElementById('saveBtn'),
                resetButton: document.getElementById('resetBtn'),
            };

            const toggleButtons = Array.from(document.querySelectorAll('.toggle[data-setting]'));

            const state = {
                activeModelId: null,
                initialSettings: null,
                modelName: 'AI 모델',
            };

            const setToggleState = (button, value) => {
                button.setAttribute('aria-pressed', value ? 'true' : 'false');
            };

            const gatherCurrentSettings = () => {
                const settings = {
                    response_style: elements.responseStyle ? elements.responseStyle.value : 'professional',
                };
                toggleButtons.forEach(button => {
                    const key = button.dataset.setting;
                    settings[key] = button.getAttribute('aria-pressed') === 'true';
                });
                return settings;
            };

            const applySettings = (settings = {}) => {
                if (elements.responseStyle) {
                    const value = settings.response_style ?? 'professional';
                    elements.responseStyle.value = value;
                }
                toggleButtons.forEach(button => {
                    const key = button.dataset.setting;
                    const value = settings[key] ?? false;
                    setToggleState(button, Boolean(value));
                });
            };

            const formatPercentage = (value) => {
                const num = Number(value);
                if (!Number.isFinite(num) || num < 0) {
                    return '-';
                }
                const formatted = Number.isInteger(num) ? num.toFixed(0) : num.toFixed(1);
                return `${formatted}%`;
            };

            const formatResponseTime = (ms) => {
                const value = Number(ms);
                if (!Number.isFinite(value) || value <= 0) {
                    return '-';
                }
                if (value >= 1000) {
                    const seconds = value / 1000;
                    const formatted = Number.isInteger(seconds) ? seconds.toFixed(0) : seconds.toFixed(1);
                    return `${formatted}초`;
                }
                return `${Math.round(value)}ms`;
            };

            const formatNumber = (value) => {
                const num = Number(value);
                if (!Number.isFinite(num)) {
                    return '-';
                }
                return num.toLocaleString('ko-KR');
            };

            const formatFeature = (feature) => {
                if (typeof feature === 'string') {
                    return feature;
                }
                if (typeof feature === 'number' || typeof feature === 'boolean') {
                    return String(feature);
                }
                if (feature && typeof feature === 'object') {
                    if (typeof feature.name === 'string') {
                        return feature.name;
                    }
                    if (typeof feature.label === 'string') {
                        return feature.label;
                    }
                    try {
                        return JSON.stringify(feature);
                    } catch (error) {
                        return '기능';
                    }
                }
                return '기능';
            };

            const renderFeatures = (features) => {
                if (!elements.modelFeatures) {
                    return;
                }
                elements.modelFeatures.innerHTML = '';

                if (!Array.isArray(features) || features.length === 0) {
                    const tag = document.createElement('span');
                    tag.className = 'feature-tag';
                    tag.textContent = '등록된 기능 없음';
                    elements.modelFeatures.appendChild(tag);
                    return;
                }

                features.forEach((feature) => {
                    const tag = document.createElement('span');
                    tag.className = 'feature-tag';
                    tag.textContent = formatFeature(feature);
                    elements.modelFeatures.appendChild(tag);
                });
            };

            const applyModelData = (model, updateBaseline = false) => {
                if (!model) {
                    return;
                }

                if (typeof model.id === 'number') {
                    state.activeModelId = model.id;
                }

                state.modelName = model.name || 'AI 모델';

                if (elements.modelName) {
                    elements.modelName.textContent = state.modelName;
                }
                if (elements.modelProvider) {
                    elements.modelProvider.textContent = model.provider_name || '제공자 정보 없음';
                }
                if (elements.modelDescription) {
                    elements.modelDescription.textContent = model.description || '모델 설명이 등록되지 않았습니다.';
                }

                renderFeatures(model.features);

                if (elements.pageSubtitle) {
                    elements.pageSubtitle.textContent = `${state.modelName} 모델의 성능과 동작을 조정하여 최적의 응답을 생성하세요`;
                }

                const statusLabel = model.is_active === false ? '비활성' : '활성';
                if (elements.statusIndicatorText) {
                    elements.statusIndicatorText.textContent = `${state.modelName} ${statusLabel}`;
                }
                if (elements.statusBadgeText) {
                    elements.statusBadgeText.textContent = model.status_text || '상태 정보 없음';
                }

                if (elements.accuracyValue) {
                    elements.accuracyValue.textContent = formatPercentage(model.accuracy);
                }
                if (elements.responseTimeValue) {
                    elements.responseTimeValue.textContent = formatResponseTime(model.avg_response_time_ms);
                }
                if (elements.monthlyConversationValue) {
                    elements.monthlyConversationValue.textContent = formatNumber(model.month_conversations);
                }
                if (elements.uptimeValue) {
                    elements.uptimeValue.textContent = formatPercentage(model.uptime_percent);
                }

                applySettings({
                    response_style: model.response_style,
                    block_inappropriate: model.block_inappropriate,
                    restrict_non_tech: model.restrict_non_tech,
                    fast_response_mode: model.fast_response_mode,
                    suggest_agent_handoff: model.suggest_agent_handoff,
                });

                if (updateBaseline) {
                    state.initialSettings = gatherCurrentSettings();
                }
            };

            toggleButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const nextState = button.getAttribute('aria-pressed') !== 'true';
                    setToggleState(button, nextState);
                });
            });

            const loadActiveModel = async () => {
                try {
                    const model = await fetchJSON(buildApiUrl('/models/active'));
                    if (!model) {
                        throw new Error('활성화된 모델 정보를 찾을 수 없습니다.');
                    }
                    applyModelData(model, true);
                    await fetchActiveModelAnalytics();
                    showNotification(`${state.modelName} 모델 설정이 준비되었습니다.`, 'success');
                } catch (error) {
                    console.error('활성 모델 정보를 불러오는 중 오류가 발생했습니다.', error);
                    showNotification(error?.message || '활성 모델 정보를 불러오지 못했습니다.', 'error');
                }
            };

            const fetchActiveModelAnalytics = async () => {
                if (!state.activeModelId) {
                    return;
                }

                try {
                    const analytics = await fetchJSON(buildApiUrl('/analytics/models'));
                    if (!Array.isArray(analytics) || analytics.length === 0) {
                        return;
                    }

                    const activeMetrics = analytics.find(item => Number(item?.model_id) === Number(state.activeModelId));
                    if (!activeMetrics) {
                        return;
                    }

                    const updateMetricValue = (element, value, formatter) => {
                        if (!element) {
                            return;
                        }
                        if (value === undefined || value === null) {
                            element.textContent = '데이터 없음';
                            return;
                        }
                        element.textContent = formatter ? formatter(value) : String(value);
                    };

                    updateMetricValue(elements.responseTimeValue, activeMetrics.avg_response_ms, formatResponseTime);
                    updateMetricValue(elements.monthlyConversationValue, activeMetrics.monthly_conversations, formatNumber);
                    updateMetricValue(elements.accuracyValue, activeMetrics.accuracy, formatPercentage);
                    updateMetricValue(elements.uptimeValue, activeMetrics.uptime_percent, formatPercentage);
                } catch (error) {
                    console.error('모델 운영 지표를 불러오는 중 오류가 발생했습니다.', error);
                    showNotification('모델 운영 지표를 불러오지 못했습니다. 잠시 후 다시 시도해주세요.', 'warning');
                }
            };

            if (elements.resetButton) {
                elements.resetButton.addEventListener('click', () => {
                    if (!state.initialSettings) {
                        showNotification('복원할 기본값이 없습니다. 먼저 모델 정보를 불러오세요.', 'warning');
                        return;
                    }
                    applySettings(state.initialSettings);
                    showNotification('설정을 기본값으로 복원했습니다.', 'info');
                });
            }

            if (elements.saveButton) {
                elements.saveButton.addEventListener('click', async function() {
                    if (!state.activeModelId) {
                        showNotification('활성 모델 정보를 불러오지 못했습니다. 잠시 후 다시 시도해주세요.', 'error');
                        return;
                    }

                    const button = this;
                    const originalLabel = button.innerHTML;
                    const originalBackground = button.style.background;
                    button.disabled = true;
                    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 저장 중...';

                    const revertButton = () => {
                        button.innerHTML = originalLabel;
                        button.style.background = originalBackground || 'var(--primary-color)';
                        button.disabled = false;
                    };

                    try {
                        const currentSettings = gatherCurrentSettings();
                        const payload = {
                            response_style: currentSettings.response_style,
                            block_inappropriate: currentSettings.block_inappropriate,
                            restrict_non_tech: currentSettings.restrict_non_tech,
                            fast_response_mode: currentSettings.fast_response_mode,
                            suggest_agent_handoff: currentSettings.suggest_agent_handoff,
                        };

                        const updated = await fetchJSON(buildApiUrl(`/models/${state.activeModelId}`), {
                            method: 'PATCH',
                            body: payload,
                        });

                        if (updated) {
                            applyModelData(updated, true);
                            await fetchActiveModelAnalytics();
                        } else {
                            state.initialSettings = gatherCurrentSettings();
                        }

                        button.innerHTML = '<i class="fas fa-check"></i> 저장 완료!';
                        button.style.background = 'var(--accent-color)';
                        showNotification('AI 모델 설정이 저장되었습니다. 변경사항이 즉시 적용됩니다.', 'success');

                        setTimeout(() => {
                            revertButton();
                        }, 2000);
                    } catch (error) {
                        console.error('모델 설정 저장 중 오류가 발생했습니다.', error);
                        showNotification(error?.message || '설정을 저장하지 못했습니다.', 'error');
                        revertButton();
                    }
                });
            }

            loadActiveModel();
        });

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                max-width: 400px;
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            `;

            const colors = {
                success: '#28a745',
                error: '#dc3545',
                warning: '#ffc107',
                info: '#17a2b8'
            };

            notification.style.background = colors[type] || colors.info;
            notification.textContent = message;

            document.body.appendChild(notification);

            requestAnimationFrame(() => {
                notification.style.transform = 'translateX(0)';
            });

            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
    </script>
</body>

</html>
